<!doctype html>
<html lang="en">

<head>
    <title>{% block title %}{% endblock %} - Fitness Finder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <div id="background-image"></div>
    <div class="full-body-container">
        <div class="top-text">
            <h1 class="main-title">Workout.ai</h1>
            <h2 class="sub-title">Get the right workout for your gear and goals.</h2>

            <!-- Search box -->
            <div class="input-box">
                <input placeholder="What exercise are you looking for?" id="filter-text-val">
                <button class="generate-btn left-btn" id="search-button" onclick="filterText()">Generate
                    Exercises</button>
                <button class="generate-btn" id="routine-button" onclick="generateRoutine()">Generate Full
                    Routine</button>
            </div>




            <div class="filter-row-container">
                <!-- Equipment Filters -->
                <div class="filter-box">
                    <p class="filter-label">Equipment</p>
                    <div class="filter-group" id="equipment-filters">
                        <button class="filter-btn active" data-type="equipment" data-value="">All</button>
                        <button class="filter-btn" data-type="equipment" data-value="Dumbbell">Dumbbell</button>
                        <button class="filter-btn" data-type="equipment" data-value="Barbell">Barbell</button>
                        <button class="filter-btn" data-type="equipment" data-value="Cable">Cable</button>
                        <button class="filter-btn" data-type="equipment" data-value="Exercise Ball">Exercise
                            Ball</button>
                        <button class="filter-btn" data-type="equipment" data-value="Foam Roll">Foam Roll</button>
                        <button class="filter-btn" data-type="equipment" data-value="Kettlebells">Kettlebells</button>
                        <button class="filter-btn" data-type="equipment" data-value="Machine">Machine</button>
                        <button class="filter-btn" data-type="equipment" data-value="None">None</button>
                        <button class="filter-btn" data-type="equipment" data-value="Other">Other</button>
                    </div>
                </div>

                <!-- Target Filters -->
                <div class="filter-box">
                    <p class="filter-label">Target</p>
                    <div class="filter-group" id="bodypart-filters">
                        <button class="filter-btn active" data-type="bodypart" data-value="">All</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Abdominals">Abdominals</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Abductors">Abductors</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Adductors">Adductors</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Biceps">Biceps</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Calves">Calves</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Chest">Chest</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Forearms">Forearms</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Glutes">Glutes</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Hamstrings">Hamstrings</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Lats">Lats</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Lower Back">Lower Back</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Middle Back">Middle Back</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Quadriceps">Quadriceps</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Shoulders">Shoulders</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Traps">Traps</button>
                        <button class="filter-btn" data-type="bodypart" data-value="Triceps">Triceps</button>
                    </div>
                </div>
            </div>

            <!-- Results box -->
            <div id="answer-box"></div>
        </div>

        <script>
            let selectedEquipment = "";
            let selectedBodypart = "";
        
            function showSpinner() {
                document.getElementById("loading-spinner").style.display = "flex";
            }
        
            function hideSpinner() {
                document.getElementById("loading-spinner").style.display = "none";
            }
        
            function goToExercise(url) {
                showSpinner();
                setTimeout(() => window.location.href = url, 100);
            }
        
            function expandCard(card) {
                document.querySelectorAll('.card-expanded').forEach(expanded => {
                    expanded.style.display = 'none';
                    if (expanded.previousElementSibling)
                        expanded.previousElementSibling.style.display = 'block';
                });
        
                card.style.display = "none";
                const expanded = card.nextElementSibling;
                expanded.style.display = "block";
                expanded.style.opacity = 0;
        
                const title = card.querySelector(".exercise-title").innerText;
                const videoElem = expanded.querySelector(".video-link");
        
                if (videoElem) {
                    fetch(`/video/${encodeURIComponent(title)}`)
                        .then(res => res.json())
                        .then(data => {
                            videoElem.innerHTML = data.Video ? `<a href="${data.Video}" target="_blank">Watch on YouTube</a>` : "N/A";
                        })
                        .catch(() => videoElem.textContent = "N/A");
                }
        
                requestAnimationFrame(() => expanded.style.opacity = 1);
            }
        
            function closeCard(btn) {
                const expanded = btn.parentElement;
                expanded.style.display = "none";
                expanded.previousElementSibling.style.display = "block";
            }
        
            function answerBoxTemplate(row) {
                return `
                    <div class='exercise-card'>
                        <div class='card-front' onclick="expandCard(this)">
                            <h3 class='exercise-title'>${row.Title}</h3>
                            <p class='exercise-desc'>${row.Desc}</p>
                            <p><strong>Rating:</strong> ${row.Rating ?? 'N/A'}</p>
                        </div>
                        <div class='card-expanded'>
                            <button class='close-btn' onclick="closeCard(this)">Ã—</button>
                            <p><strong>Description:</strong> ${row.Desc}</p>
                            <p><strong><i class="fas fa-dumbbell"></i> Muscle Group:</strong> ${row.BodyPart}</p>
                            <p><strong><i class="fas fa-cogs"></i> Equipment:</strong> ${row.Equipment}</p>
                            <p><strong><i class="fas fa-signal"></i> Level:</strong> ${row.Level}</p>
                            <p><strong><i class="fas fa-star"></i> Rating:</strong> ${row.Rating}</p>
                            <p><strong><i class="fas fa-battery-half"></i> Fatigue Level:</strong> ${row.FatigueLevel}</p>
                            <p><strong><i class="fab fa-youtube"></i> Video:</strong> <span class="video-link">Loading...</span></p>
                        </div>
                    </div>`;
            }
        
            function filterText() {
                document.getElementById("answer-box").innerHTML = "";
                showSpinner();
        
                const query = document.getElementById("filter-text-val").value;
                const params = { title: query };
                if (selectedEquipment) params.equipment = selectedEquipment;
                if (selectedBodypart) params.bodypart = selectedBodypart;
        
                fetch("/exercises?" + new URLSearchParams(params))
                    .then(res => res.json())
                    .then(data => {
                        const answerBox = document.getElementById("answer-box");
                        if (!data.length) {
                            answerBox.innerHTML = "<div class='no-results'>No workouts found. Try another search.</div>";
                            return;
                        }
        
                        data.forEach(row => {
                            const div = document.createElement("div");
                            div.innerHTML = answerBoxTemplate(row);
                            answerBox.appendChild(div);
                        });
                    })
                    .finally(hideSpinner);
            }
        
            function generateRoutine() {
                document.getElementById("answer-box").innerHTML = "";
                showSpinner();

                const query = document.getElementById("filter-text-val").value;
                const params = { title: query };
                if (selectedEquipment) params.equipment = selectedEquipment;

                fetch("/routine?" + new URLSearchParams(params))
                    .then(res => res.json())
                    .then(data => {
                        const answerBox = document.getElementById("answer-box");
                        
                        if (!data.main || !data.main.length) {
                            answerBox.innerHTML = "<div class='no-results'>No routine found. Try a query like 'arms', 'core', or 'legs'.</div>";
                            return;
                        }

                        const mainWrapper = document.createElement("div");
                        mainWrapper.className = "routine-wrapper";
                        mainWrapper.innerHTML = `<h3>Main Routine</h3>`;
                        
                        data.main.forEach(ex => {
                            const div = document.createElement("div");
                            div.innerHTML = answerBoxTemplate(ex);
                            mainWrapper.appendChild(div);
                        });

                        if (data.related && data.related.length) {
                            const relatedWrapper = document.createElement("div");
                            relatedWrapper.className = "routine-wrapper";
                            relatedWrapper.innerHTML = `<h3>Related Exercises</h3>`;
                            
                            data.related.forEach(ex => {
                                const div = document.createElement("div");
                                div.innerHTML = answerBoxTemplate(ex);
                                relatedWrapper.appendChild(div);
                            });
                            
                            mainWrapper.appendChild(relatedWrapper);
                        }

                        answerBox.appendChild(mainWrapper);
                    })
                    .catch(error => {
                        console.error("Error fetching routine:", error);
                        document.getElementById("answer-box").innerHTML = 
                            "<div class='no-results'>Error loading routine. Please try again.</div>";
                    })
                    .finally(hideSpinner);
            }
        
            // document.addEventListener("DOMContentLoaded", () => {
            //     document.querySelectorAll('.filter-btn').forEach(btn => {
            //         btn.addEventListener('click', () => {
            //             const { type, value } = btn.dataset;
            //             document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
            //             btn.classList.add('active');
            //             if (type === "equipment") selectedEquipment = value;
            //             if (type === "bodypart") selectedBodypart = value;
            //         });
            //     });
        
            //     document.getElementById("filter-text-val").addEventListener("keypress", e => {
            //         if (e.key === "Enter") filterText();
            //     });
            // });

            document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { type, value } = btn.dataset;
                    document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    if (type === "equipment") selectedEquipment = value;
                    if (type === "bodypart") selectedBodypart = value;

                    const useRoutine = document.getElementById("routine-button").classList.contains("active");

            // Automatically refresh results
                    const query = document.getElementById("filter-text-val").value.trim();
                    if (useRoutine) {
                        generateRoutine();
                    } else {
                        filterText();
                    }
                });
            });

            document.getElementById("filter-text-val").addEventListener("keypress", e => {
                if (e.key === "Enter") filterText();
            });
        });
        </script>        

        <div id="loading-spinner">
            <div class="spinner-circle"></div>
        </div>
    </div>
</body>

</html>